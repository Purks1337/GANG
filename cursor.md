## Этапы 2–4: детальный план выполнения

- Этот план рассчитан на последовательное выполнение и проверку после каждого шага.
- Цели этапов:
  - Этап 2: Поднять и настроить backend (WordPress + WooCommerce + плагины WPGraphQL/ЮKassa/СДЭК)
  - Этап 3: Интегрировать фронтенд через WPGraphQL (получение товаров/вариаций, создание заказа, редирект на оплату)
  - Этап 4: Провести сквозное тестирование (end-to-end) потока заказа

### Предпосылки и окружение
- Доступный домен или временный субдомен для WP (например, `wp.gang-ground.dev`)
- PHP-хостинг с параметрами: PHP 8.1+, MySQL 5.7+/MariaDB 10.4+, HTTPS
- Опционально: локальная разработка на Docker (wp-env) — fallback, если нет хостинга
- Данные для платежей (тестовые ключи ЮKassa или Тинькофф)
- Аккаунт СДЭК для тестовой интеграции (если требуется минимальная проверка)

---

## Этап 2. Backend-настройка (WordPress + WooCommerce)

### 2.1. Установка и базовая конфигурация WordPress
- Развернуть WordPress на выбранном хостинге/сервере
- Настроить HTTPS (Let's Encrypt)
- Включить постоянные ссылки (/%postname%)
- Создать админ-аккаунт и ограниченный редакторский доступ (для менеджера)

### 2.2. Установка и настройка WooCommerce
- Установить плагин WooCommerce
- Запустить мастер начальной настройки: валюта ₽, страна/город, НДС (при необходимости)
- Настроить базовые статические страницы WooCommerce (Cart/Checkout/My Account — можно скрыть во фронтенде)

### 2.3. Установка WPGraphQL и расширений
- Установить плагины:
  - WPGraphQL
  - WPGraphQL for WooCommerce (расширение схемы)
  - (Опционально) WPGraphiQL для интерактивного теста
- Проверить доступность GraphQL эндпоинта: `/graphql`
- Включить кеширование схемы, при необходимости настроить пермишены

### 2.4. Настройка платёжного шлюза (ЮKassa или Тинькофф)
- Установить официальный плагин платежей для WooCommerce
- Включить тестовый режим
- Ввести тестовые ключи (Shop ID, Secret Key)
- Задать URL возврата/уведомлений (callback/return URLs)
- Включить методы оплаты: карта, SBP (по необходимости)

### 2.5. Настройка доставки (СДЭК)
- Установить плагин СДЭК для WooCommerce
- Включить тестовый режим/ввести API-ключи
- Упростить конфигурацию: единая фиксированная стоимость или расчет плагином в админке (без фронтенд-калькулятора)

### 2.6. Модель каталога и товары
- Создать категорию(и) (для MVP — одна «Все товары»)
- Создать 4–5 товаров с вариациями размеров (S/M/L/XL)
- Для каждой вариации указать: цену и остаток (stock)
- Добавить изображения товаров (в том числе для галереи)

### 2.7. Безопасность и производительность
- Плагины: ограничение попыток входа, автобэкапы (Updraft), кеширование (WP Super Cache/Redis при наличии)
- Включить автoобновления минорных версий

### Контрольные точки Этапа 2
- `/graphql` работает, схема содержит сущности товаров/вариаций/заказов
- В админке заведены реальные товары и вариации с остатками
- Платёжный шлюз в тестовом режиме готов принимать платежи
- Плагин СДЭК активен (даже если фронтенд без калькулятора)

---

## Этап 3. Интеграция фронтенда с WPGraphQL

### 3.1. Конфигурация фронтенда
- Добавить переменные окружения в проект:
  - `NEXT_PUBLIC_WP_GRAPHQL_ENDPOINT=https://<wp-host>/graphql`
  - `WP_API_AUTH` (если требуется токен/Basic Auth для мутаций админского уровня)
- Подготовить легковесный GraphQL-клиент (например, `graphql-request`) или fetch-обертку

### 3.2. Запросы данных каталога
- Реализовать запрос: список товаров (название, slug, цена по умолчанию, главное изображение)
- Маппинг на существующие компоненты `Catalog` и `ProductCard`
- Пагинация (при необходимости) или ограничение на 20–50 товаров

### 3.3. Страница товара (PDP)
- Запрос товара по `slug`
- Получить список вариаций (size), цену и остаток по каждой вариации
- Обновить логику выбора размера: блокировать недоступные (stock = 0)

### 3.4. Корзина и оформление
- Корзина остаётся клиентской (Context + localStorage), но цены/остатки валидируются по API на шаге оформления
- Добавить страницу `/checkout`:
  - Форма контактов: имя, телефон, email
  - Адрес/пункт выдачи (упрощенно — одно текстовое поле)
  - Кнопка «Перейти к оплате»

### 3.5. Создание заказа и редирект на оплату
- Реализовать серверный экшн/route в Next.js:
  - Валидация корзины (актуальные цены/stock через GraphQL)
  - Создание заказа/черновика заказа в WooCommerce (через REST/WPGraphQL — в зависимости от доступности мутации)
  - Инициация платежа (через WooCommerce платежный плагин → URL оплаты)
  - Возврат фронту URL для редиректа
- На фронте: редирект пользователя на страницу оплаты провайдера

### 3.6. Callback/return обработка
- Создать страницы: `/order/success`, `/order/fail`
- Обработать return URL (query-параметры), проверить статус заказа в WooCommerce
- Очистить корзину при успешной оплате

### 3.7. Ошибки и устойчивость
- Добавить обработку ошибок сетевых запросов и таймауты
- Отображать пользователю понятные статусы (валидация размера/остатка/цены)

### Контрольные точки Этапа 3
- Каталог и PDP получают данные из WordPress
- `/checkout` создает заказ, возвращает URL оплаты и делает редирект
- Возврат со страницы оплаты меняет состояние заказа и очищает корзину

---

## Этап 4. Тестирование (end-to-end)

### 4.1. Набор тестовых сценариев
- Навигация: Главная → Каталог → Товар → Корзина → Оформление
- Выбор размера, проверка недоступных размеров
- Корзина: изменение количества, пересчет суммы
- Оформление: валидация контактов
- Создание заказа: валидация цен и остатков
- Редирект на оплату и возврат на `/order/success`/`/order/fail`

### 4.2. Тестовые платежи
- ЮKassa/Тинькофф: тестовые карты, проверка успешного и неуспешного платежа
- Проверка корректности сумм и валюты

### 4.3. Регресс и производительность
- Smoke-тест всех страниц
- Проверка SEO/SSR (мета, заголовки)
- Lighthouse проверки (перфоманс/а11y/best practices/SEO)

### 4.4. Готовность к релизу
- Все сценарии «зелёные», корзина очищается после success
- Логи ошибок пусты/минимальны
- Документация: как обновлять товары/вариации, где смотреть заказы

---

## Артефакты и задачи по итогам
- Чек-лист конфигураций: плагины, ключи, URL возврата
- Настроенные переменные окружения и инструкции по деплою
- Отчет о прохождении e2e-сценариев и фиксация версий

## Риски и пометки
- Мутации заказов в WPGraphQL могут быть ограничены — fallback на REST API WooCommerce
- Платежные плагины часто требуют точных return/callback URL — согласовать заранее
- СДЭК для MVP оставляем в админке (без фронтенд калькулятора)
